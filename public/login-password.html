
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Enter Password</title>
    <link rel="stylesheet" href="/reset.css" />
    <link rel="stylesheet" href="/auth.css" />
    <script defer src="/app.js"></script>
  </head>
  <body class="page-auth">
    <div class="brand-bar">
      <div class="brand">JPMorgan Chase &amp; Co.</div>
    </div>

    <main class="auth-main">
      <section class="auth-card" role="form" aria-labelledby="title">
        <h1 id="title" class="auth-h1">Enter your password</h1>

        <form id="pwForm" class="form">
          <div class="field-readonly">
            <div class="label">Standard ID (SID)</div>
            <div id="sidView" class="sid-chip"></div>
          </div>

          <label class="label" for="password">Password</label>
          <input id="password" name="password" type="password" class="input" autocomplete="current-password" required />

          <div class="row">
            <button class="btn btn-ghost" type="button" id="backBtn">Back</button>
            <button class="btn btn-primary" type="submit">Sign in</button>
          </div>

          <p class="aux">
            <a class="link" href="/forgot.html">Forgot password?</a>
          </p>

          <p id="msg" class="msg" role="alert" hidden></p>
        </form>
      </section>
    </main>

    <script>
      // API helper for login page
      window.api = {
        async post(path, data, options = {}) {
          const headers = { 
            "Content-Type": "application/json",
            ...options.headers 
          };

          const res = await fetch(`/api${path}`, {
            method: "POST",
            headers,
            body: JSON.stringify(data),
            ...options
          });
          
          if (!res.ok) {
            const err = await res.json().catch(() => ({ error: "Network error" }));
            throw new Error(err.error || `HTTP ${res.status}`);
          }
          return res.json();
        },

        setToken(token) {
          localStorage.setItem("token", token);
        }
      };

      (function () {
        const qs = new URLSearchParams(location.search);
        const sid = qs.get("sid") || sessionStorage.getItem("sid") || "";
        const sidView = document.getElementById("sidView");
        const msg = document.getElementById("msg");
        const backBtn = document.getElementById("backBtn");
        const form = document.getElementById("pwForm");

        sidView.textContent = sid || "(unknown)";

        function show(t, good=false){
          msg.textContent = t;
          msg.className = "msg " + (good ? "ok":"err");
          msg.hidden = false;
        }

        backBtn.addEventListener("click", () => history.back());

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          msg.hidden = true;
          const password = form.password.value;

          try {
            const res = await window.api.post("/auth/login", { sid, password });
            if (res?.token) {
              window.api.setToken(res.token);
              show("Signed in. Redirectingâ€¦", true);
              setTimeout(() => (location.href = "/index.html"), 350);
            } else {
              show("Unexpected response from server.");
            }
          } catch (err) {
            show(err.message || "Sign-in failed.");
          }
        });
      })();
    </script>
  </body>
</html>
